import { CredentialsProviderError } from "@aws-sdk/property-provider";
import { httpRequest } from "./remoteProvider/httpRequest";
import { fromImdsCredentials, isImdsCredentials } from "./remoteProvider/ImdsCredentials";
import { providerConfigFromInit } from "./remoteProvider/RemoteProviderInit";
import { retry } from "./remoteProvider/retry";
import { getInstanceMetadataEndpoint } from "./utils/getInstanceMetadataEndpoint";
import { staticStabilityProvider } from "./utils/staticStabilityProvider";
const IMDS_PATH = "/latest/meta-data/iam/security-credentials/";
const IMDS_TOKEN_PATH = "/latest/api/token";
export const fromInstanceMetadata = (init = {}) => staticStabilityProvider(getInstanceImdsProvider(init), { logger: init.logger ***REMOVED***
const getInstanceImdsProvider = (init) => {
    let disableFetchToken = false;
    const { timeout, maxRetries } = providerConfigFromInit(init);
    const getCredentials = async (maxRetries, options) => {
        const profile = (await retry(async () => {
            let profile;
          ***REMOVED***
                profile = await getProfile(options);
        ***REMOVED***
            catch (err) {
                if (err.statusCode === 401) {
                    disableFetchToken = false;
            ***REMOVED***
                throw err;
        ***REMOVED***
            return profile;
    ***REMOVED***, maxRetries)).trim();
        return retry(async () => {
            let creds;
          ***REMOVED***
                creds = await getCredentialsFromProfile(profile, options);
        ***REMOVED***
            catch (err) {
                if (err.statusCode === 401) {
                    disableFetchToken = false;
            ***REMOVED***
                throw err;
        ***REMOVED***
            return creds;
    ***REMOVED***, maxRetries);
***REMOVED***;
    return async () => {
        const endpoint = await getInstanceMetadataEndpoint();
        if (disableFetchToken) {
            return getCredentials(maxRetries, { ...endpoint, timeout ***REMOVED***
    ***REMOVED***
        else {
            let token;
          ***REMOVED***
                token = (await getMetadataToken({ ...endpoint, timeout })).toString();
        ***REMOVED***
            catch (error) {
                if (error?.statusCode === 400) {
                    throw Object.assign(error, {
                        message: "EC2 Metadata token request returned error",
                    ***REMOVED***
            ***REMOVED***
                else if (error.message === "TimeoutError" || [403, 404, 405].includes(error.statusCode)) {
                    disableFetchToken = true;
            ***REMOVED***
                return getCredentials(maxRetries, { ...endpoint, timeout ***REMOVED***
        ***REMOVED***
            return getCredentials(maxRetries, {
                ...endpoint,
                headers: {
                    "x-aws-ec2-metadata-token": token,
            ***REMOVED***,
                timeout,
            ***REMOVED***
    ***REMOVED***
***REMOVED***;
};
const getMetadataToken = async (options) => httpRequest({
    ...options,
    path: IMDS_TOKEN_PATH,
    method: "PUT",
    headers: {
        "x-aws-ec2-metadata-token-ttl-seconds": "21600",
***REMOVED***,
***REMOVED***
const getProfile = async (options) => (await httpRequest({ ...options, path: IMDS_PATH })).toString();
const getCredentialsFromProfile = async (profile, options) => {
    const credsResponse = JSON.parse((await httpRequest({
        ...options,
        path: IMDS_PATH + profile,
***REMOVED***)).toString());
    if (!isImdsCredentials(credsResponse)) {
        throw new CredentialsProviderError("Invalid response received from instance metadata service.");
***REMOVED***
    return fromImdsCredentials(credsResponse);
};
