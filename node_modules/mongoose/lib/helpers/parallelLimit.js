'use strict';

module.exports = parallelLimit;

/*!
 * ignore
 */

function parallelLimit(fns, limit, callback) {
  let numInProgress = 0;
  let numFinished = 0;
  let error = null;

  if (limit <= 0) {
    throw new Error('Limit must be positive');
***REMOVED***

  if (fns.length === 0) {
    return callback(null, []);
***REMOVED***

  for (let i = 0; i < fns.length && i < limit; ++i) {
    _start();
***REMOVED***

  function _start() {
    fns[numFinished + numInProgress](_done(numFinished + numInProgress));
    ++numInProgress;
***REMOVED***

  const results = [];

  function _done(index) {
    return (err, res) => {
      --numInProgress;
      ++numFinished;

      if (error != null) {
        return;
  ***REMOVED***
      if (err != null) {
        error = err;
        return callback(error);
  ***REMOVED***

      results[index] = res;

      if (numFinished === fns.length) {
        return callback(null, results);
  ***REMOVED*** else if (numFinished + numInProgress < fns.length) {
        _start();
  ***REMOVED***
***REMOVED***;
***REMOVED***
}
